var tzinfo =
{
    "Africa/Abidjan": "GMT0",
    "Africa/Accra": "GMT0",
    "Africa/Addis_Ababa": "EAT-3",
    "Africa/Algiers": "CET-1",
    "Africa/Asmara": "EAT-3",
    "Africa/Asmera": "EAT-3",
    "Africa/Bamako": "GMT0",
    "Africa/Bangui": "WAT-1",
    "Africa/Banjul": "GMT0",
    "Africa/Bissau": "GMT0",
    "Africa/Blantyre": "CAT-2",
    "Africa/Brazzaville": "WAT-1",
    "Africa/Bujumbura": "CAT-2",
    "Africa/Cairo": "EET-2",
    "Africa/Casablanca": "-1",
    "Africa/Ceuta": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Africa/Conakry": "GMT0",
    "Africa/Dakar": "GMT0",
    "Africa/Dar_es_Salaam": "EAT-3",
    "Africa/Djibouti": "EAT-3",
    "Africa/Douala": "WAT-1",
    "Africa/El_Aaiun": "-1",
    "Africa/Freetown": "GMT0",
    "Africa/Gaborone": "CAT-2",
    "Africa/Harare": "CAT-2",
    "Africa/Johannesburg": "SAST-2",
    "Africa/Juba": "CAT-2",
    "Africa/Kampala": "EAT-3",
    "Africa/Khartoum": "CAT-2",
    "Africa/Kigali": "CAT-2",
    "Africa/Kinshasa": "WAT-1",
    "Africa/Lagos": "WAT-1",
    "Africa/Libreville": "WAT-1",
    "Africa/Lome": "GMT0",
    "Africa/Luanda": "WAT-1",
    "Africa/Lubumbashi": "CAT-2",
    "Africa/Lusaka": "CAT-2",
    "Africa/Malabo": "WAT-1",
    "Africa/Maputo": "CAT-2",
    "Africa/Maseru": "SAST-2",
    "Africa/Mbabane": "SAST-2",
    "Africa/Mogadishu": "EAT-3",
    "Africa/Monrovia": "GMT0",
    "Africa/Nairobi": "EAT-3",
    "Africa/Ndjamena": "WAT-1",
    "Africa/Niamey": "WAT-1",
    "Africa/Nouakchott": "GMT0",
    "Africa/Ouagadougou": "GMT0",
    "Africa/Porto-Novo": "WAT-1",
    "Africa/Sao_Tome": "GMT0",
    "Africa/Timbuktu": "GMT0",
    "Africa/Tripoli": "EET-2",
    "Africa/Tunis": "CET-1",
    "Africa/Windhoek": "CAT-2",
    "America/Adak": "HST10HDT,M3.2.0,M11.1.0",
    "America/Anchorage": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/Anguilla": "AST4",
    "America/Antigua": "AST4",
    "America/Araguaina": "3",
    "America/Aruba": "AST4",
    "America/Asuncion": "4",
    "America/Atikokan": "EST5",
    "America/Atka": "HST10HDT,M3.2.0,M11.1.0",
    "America/Bahia": "3",
    "America/Bahia_Banderas": "CST6CDT,M4.1.0,M10.5.0",
    "America/Barbados": "AST4",
    "America/Belem": "3",
    "America/Belize": "CST6",
    "America/Blanc-Sablon": "AST4",
    "America/Boa_Vista": "4",
    "America/Bogota": "5",
    "America/Boise": "MST7MDT,M3.2.0,M11.1.0",
    "America/Buenos_Aires": "3",
    "America/Cambridge_Bay": "MST7MDT,M3.2.0,M11.1.0",
    "America/Campo_Grande": "4",
    "America/Cancun": "EST5",
    "America/Caracas": "4",
    "America/Catamarca": "3",
    "America/Cayenne": "3",
    "America/Cayman": "EST5",
    "America/Chicago": "CST6CDT,M3.2.0,M11.1.0",
    "America/Chihuahua": "MST7MDT,M4.1.0,M10.5.0",
    "America/Coral_Harbour": "EST5",
    "America/Cordoba": "3",
    "America/Costa_Rica": "CST6",
    "America/Creston": "MST7",
    "America/Cuiaba": "4",
    "America/Curacao": "AST4",
    "America/Danmarkshavn": "GMT0",
    "America/Dawson": "MST7",
    "America/Dawson_Creek": "MST7",
    "America/Denver": "MST7MDT,M3.2.0,M11.1.0",
    "America/Detroit": "EST5EDT,M3.2.0,M11.1.0",
    "America/Dominica": "AST4",
    "America/Edmonton": "MST7MDT,M3.2.0,M11.1.0",
    "America/Eirunepe": "5",
    "America/El_Salvador": "CST6",
    "America/Ensenada": "PST8PDT,M3.2.0,M11.1.0",
    "America/Fortaleza": "3",
    "America/Fort_Nelson": "MST7",
    "America/Fort_Wayne": "EST5EDT,M3.2.0,M11.1.0",
    "America/Glace_Bay": "AST4ADT,M3.2.0,M11.1.0",
    "America/Goose_Bay": "AST4ADT,M3.2.0,M11.1.0",
    "America/Grand_Turk": "EST5EDT,M3.2.0,M11.1.0",
    "America/Grenada": "AST4",
    "America/Guadeloupe": "AST4",
    "America/Guatemala": "CST6",
    "America/Guayaquil": "5",
    "America/Guyana": "4",
    "America/Halifax": "AST4ADT,M3.2.0,M11.1.0",
    "America/Havana": "CST5CDT,M3.2.0/0,M11.1.0/1",
    "America/Hermosillo": "MST7",
    "America/Indianapolis": "EST5EDT,M3.2.0,M11.1.0",
    "America/Inuvik": "MST7MDT,M3.2.0,M11.1.0",
    "America/Iqaluit": "EST5EDT,M3.2.0,M11.1.0",
    "America/Jamaica": "EST5",
    "America/Jujuy": "3",
    "America/Juneau": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/Knox_IN": "CST6CDT,M3.2.0,M11.1.0",
    "America/Kralendijk": "AST4",
    "America/La_Paz": "4",
    "America/Lima": "5",
    "America/Los_Angeles": "PST8PDT,M3.2.0,M11.1.0",
    "America/Louisville": "EST5EDT,M3.2.0,M11.1.0",
    "America/Lower_Princes": "AST4",
    "America/Maceio": "3",
    "America/Managua": "CST6",
    "America/Manaus": "4",
    "America/Marigot": "AST4",
    "America/Martinique": "AST4",
    "America/Matamoros": "CST6CDT,M3.2.0,M11.1.0",
    "America/Mazatlan": "MST7MDT,M4.1.0,M10.5.0",
    "America/Mendoza": "3",
    "America/Menominee": "CST6CDT,M3.2.0,M11.1.0",
    "America/Merida": "CST6CDT,M4.1.0,M10.5.0",
    "America/Metlakatla": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/Mexico_City": "CST6CDT,M4.1.0,M10.5.0",
    "America/Miquelon": "3",
    "America/Moncton": "AST4ADT,M3.2.0,M11.1.0",
    "America/Monterrey": "CST6CDT,M4.1.0,M10.5.0",
    "America/Montevideo": "3",
    "America/Montreal": "EST5EDT,M3.2.0,M11.1.0",
    "America/Montserrat": "AST4",
    "America/Nassau": "EST5EDT,M3.2.0,M11.1.0",
    "America/New_York": "EST5EDT,M3.2.0,M11.1.0",
    "America/Nipigon": "EST5EDT,M3.2.0,M11.1.0",
    "America/Nome": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/Noronha": "2",
    "America/Ojinaga": "MST7MDT,M3.2.0,M11.1.0",
    "America/Panama": "EST5",
    "America/Pangnirtung": "EST5EDT,M3.2.0,M11.1.0",
    "America/Paramaribo": "3",
    "America/Phoenix": "MST7",
    "America/Port-au-Prince": "EST5EDT,M3.2.0,M11.1.0",
    "America/Porto_Acre": "5",
    "America/Porto_Velho": "4",
    "America/Port_of_Spain": "AST4",
    "America/Puerto_Rico": "AST4",
    "America/Punta_Arenas": "3",
    "America/Rainy_River": "CST6CDT,M3.2.0,M11.1.0",
    "America/Rankin_Inlet": "CST6CDT,M3.2.0,M11.1.0",
    "America/Recife": "3",
    "America/Regina": "CST6",
    "America/Resolute": "CST6CDT,M3.2.0,M11.1.0",
    "America/Rio_Branco": "5",
    "America/Rosario": "3",
    "America/Santarem": "3",
    "America/Santa_Isabel": "PST8PDT,M3.2.0,M11.1.0",
    "America/Santo_Domingo": "AST4",
    "America/Sao_Paulo": "3",
    "America/Scoresbysund": "1",
    "America/Shiprock": "MST7MDT,M3.2.0,M11.1.0",
    "America/Sitka": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/St_Barthelemy": "AST4",
    "America/St_Johns": "NST3",
    "America/St_Kitts": "AST4",
    "America/St_Lucia": "AST4",
    "America/St_Thomas": "AST4",
    "America/St_Vincent": "AST4",
    "America/Swift_Current": "CST6",
    "America/Tegucigalpa": "CST6",
    "America/Thule": "AST4ADT,M3.2.0,M11.1.0",
    "America/Thunder_Bay": "EST5EDT,M3.2.0,M11.1.0",
    "America/Tijuana": "PST8PDT,M3.2.0,M11.1.0",
    "America/Toronto": "EST5EDT,M3.2.0,M11.1.0",
    "America/Tortola": "AST4",
    "America/Vancouver": "PST8PDT,M3.2.0,M11.1.0",
    "America/Virgin": "AST4",
    "America/Whitehorse": "MST7",
    "America/Winnipeg": "CST6CDT,M3.2.0,M11.1.0",
    "America/Yakutat": "AKST9AKDT,M3.2.0,M11.1.0",
    "America/Yellowknife": "MST7MDT,M3.2.0,M11.1.0",
    "America/Argentina/Buenos_Aires": "3",
    "America/Argentina/Catamarca": "3",
    "America/Argentina/ComodRivadavia": "3",
    "America/Argentina/Cordoba": "3",
    "America/Argentina/Jujuy": "3",
    "America/Argentina/La_Rioja": "3",
    "America/Argentina/Mendoza": "3",
    "America/Argentina/Rio_Gallegos": "3",
    "America/Argentina/Salta": "3",
    "America/Argentina/San_Juan": "3",
    "America/Argentina/San_Luis": "3",
    "America/Argentina/Tucuman": "3",
    "America/Argentina/Ushuaia": "3",
    "America/Indiana/Indianapolis": "EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Knox": "CST6CDT,M3.2.0,M11.1.0",
    "America/Indiana/Marengo": "EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Petersburg": "EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Tell_City": "CST6CDT,M3.2.0,M11.1.0",
    "America/Indiana/Vevay": "EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Vincennes": "EST5EDT,M3.2.0,M11.1.0",
    "America/Indiana/Winamac": "EST5EDT,M3.2.0,M11.1.0",
    "America/Kentucky/Louisville": "EST5EDT,M3.2.0,M11.1.0",
    "America/Kentucky/Monticello": "EST5EDT,M3.2.0,M11.1.0",
    "America/North_Dakota/Beulah": "CST6CDT,M3.2.0,M11.1.0",
    "America/North_Dakota/Center": "CST6CDT,M3.2.0,M11.1.0",
    "America/North_Dakota/New_Salem": "CST6CDT,M3.2.0,M11.1.0",
    "Antarctica/Casey": "-11",
    "Antarctica/Davis": "-7",
    "Antarctica/DumontDUrville": "-10",
    "Antarctica/Macquarie": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Antarctica/Mawson": "-5",
    "Antarctica/McMurdo": "NZST-12NZDT,M9.5.0,M4.1.0/3",
    "Antarctica/Palmer": "3",
    "Antarctica/Rothera": "3",
    "Antarctica/South_Pole": "NZST-12NZDT,M9.5.0,M4.1.0/3",
    "Antarctica/Syowa": "-3",
    "Antarctica/Troll": "0",
    "Antarctica/Vostok": "-6",
    "Arctic/Longyearbyen": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Asia/Aden": "-3",
    "Asia/Almaty": "-6",
    "Asia/Amman": "EET-2EEST,M3.5.4/24,M10.5.5/1",
    "Asia/Anadyr": "-12",
    "Asia/Aqtau": "-5",
    "Asia/Aqtobe": "-5",
    "Asia/Ashgabat": "-5",
    "Asia/Ashkhabad": "-5",
    "Asia/Atyrau": "-5",
    "Asia/Baghdad": "-3",
    "Asia/Bahrain": "-3",
    "Asia/Baku": "-4",
    "Asia/Bangkok": "-7",
    "Asia/Barnaul": "-7",
    "Asia/Beirut": "EET-2EEST,M3.5.0/0,M10.5.0/0",
    "Asia/Bishkek": "-6",
    "Asia/Brunei": "-8",
    "Asia/Calcutta": "IST-5",
    "Asia/Chita": "-9",
    "Asia/Choibalsan": "-8",
    "Asia/Chongqing": "CST-8",
    "Asia/Chungking": "CST-8",
    "Asia/Colombo": "-5",
    "Asia/Dacca": "-6",
    "Asia/Damascus": "EET-2EEST,M3.5.5/0,M10.5.5/0",
    "Asia/Dhaka": "-6",
    "Asia/Dili": "-9",
    "Asia/Dubai": "-4",
    "Asia/Dushanbe": "-5",
    "Asia/Famagusta": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Asia/Harbin": "CST-8",
    "Asia/Hong_Kong": "HKT-8",
    "Asia/Hovd": "-7",
    "Asia/Ho_Chi_Minh": "-7",
    "Asia/Irkutsk": "-8",
    "Asia/Istanbul": "-3",
    "Asia/Jakarta": "WIB-7",
    "Asia/Jayapura": "WIT-9",
    "Asia/Kabul": "-4",
    "Asia/Kamchatka": "-12",
    "Asia/Karachi": "PKT-5",
    "Asia/Kashgar": "-6",
    "Asia/Kathmandu": "-5",
    "Asia/Katmandu": "-5",
    "Asia/Khandyga": "-9",
    "Asia/Kolkata": "IST-5",
    "Asia/Krasnoyarsk": "-7",
    "Asia/Kuala_Lumpur": "-8",
    "Asia/Kuching": "-8",
    "Asia/Kuwait": "-3",
    "Asia/Macao": "CST-8",
    "Asia/Macau": "CST-8",
    "Asia/Magadan": "-11",
    "Asia/Makassar": "WITA-8",
    "Asia/Manila": "PST-8",
    "Asia/Muscat": "-4",
    "Asia/Nicosia": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Asia/Novokuznetsk": "-7",
    "Asia/Novosibirsk": "-7",
    "Asia/Omsk": "-6",
    "Asia/Oral": "-5",
    "Asia/Phnom_Penh": "-7",
    "Asia/Pontianak": "WIB-7",
    "Asia/Pyongyang": "KST-9",
    "Asia/Qatar": "-3",
    "Asia/Qostanay": "-6",
    "Asia/Qyzylorda": "-5",
    "Asia/Rangoon": "-6",
    "Asia/Riyadh": "-3",
    "Asia/Saigon": "-7",
    "Asia/Sakhalin": "-11",
    "Asia/Samarkand": "-5",
    "Asia/Seoul": "KST-9",
    "Asia/Shanghai": "CST-8",
    "Asia/Singapore": "-8",
    "Asia/Srednekolymsk": "-11",
    "Asia/Taipei": "CST-8",
    "Asia/Tashkent": "-5",
    "Asia/Tbilisi": "-4",
    "Asia/Tehran": "-3",
    "Asia/Thimbu": "-6",
    "Asia/Thimphu": "-6",
    "Asia/Tokyo": "JST-9",
    "Asia/Tomsk": "-7",
    "Asia/Ujung_Pandang": "WITA-8",
    "Asia/Ulaanbaatar": "-8",
    "Asia/Ulan_Bator": "-8",
    "Asia/Urumqi": "-6",
    "Asia/Ust-Nera": "-10",
    "Asia/Vientiane": "-7",
    "Asia/Vladivostok": "-10",
    "Asia/Yakutsk": "-9",
    "Asia/Yangon": "-6",
    "Asia/Yekaterinburg": "-5",
    "Asia/Yerevan": "-4",
    "Atlantic/Azores": "1",
    "Atlantic/Bermuda": "AST4ADT,M3.2.0,M11.1.0",
    "Atlantic/Canary": "WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Cape_Verde": "1",
    "Atlantic/Faeroe": "WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Faroe": "WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Jan_Mayen": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Atlantic/Madeira": "WET0WEST,M3.5.0/1,M10.5.0",
    "Atlantic/Reykjavik": "GMT0",
    "Atlantic/South_Georgia": "2",
    "Atlantic/Stanley": "3",
    "Atlantic/St_Helena": "GMT0",
    "Australia/ACT": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Adelaide": "ACST-9",
    "Australia/Brisbane": "AEST-10",
    "Australia/Broken_Hill": "ACST-9",
    "Australia/Canberra": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Currie": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Darwin": "ACST-9",
    "Australia/Eucla": "-8",
    "Australia/Hobart": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/LHI": "-10",
    "Australia/Lindeman": "AEST-10",
    "Australia/Lord_Howe": "-10",
    "Australia/Melbourne": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/North": "ACST-9",
    "Australia/NSW": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Perth": "AWST-8",
    "Australia/Queensland": "AEST-10",
    "Australia/South": "ACST-9",
    "Australia/Sydney": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Tasmania": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/Victoria": "AEST-10AEDT,M10.1.0,M4.1.0/3",
    "Australia/West": "AWST-8",
    "Australia/Yancowinna": "ACST-9",
    "Brazil/Acre": "5",
    "Brazil/DeNoronha": "2",
    "Brazil/East": "3",
    "Brazil/West": "4",
    "Canada/Atlantic": "AST4ADT,M3.2.0,M11.1.0",
    "Canada/Central": "CST6CDT,M3.2.0,M11.1.0",
    "Canada/Eastern": "EST5EDT,M3.2.0,M11.1.0",
    "Canada/Mountain": "MST7MDT,M3.2.0,M11.1.0",
    "Canada/Newfoundland": "NST3",
    "Canada/Pacific": "PST8PDT,M3.2.0,M11.1.0",
    "Canada/Saskatchewan": "CST6",
    "Canada/Yukon": "MST7",
    "Etc/GMT": "GMT0",
    "Etc/GMT+0": "GMT0",
    "Etc/GMT+1": "1",
    "Etc/GMT+2": "2",
    "Etc/GMT+3": "3",
    "Etc/GMT+4": "4",
    "Etc/GMT+5": "5",
    "Etc/GMT+6": "6",
    "Etc/GMT+7": "7",
    "Etc/GMT+8": "8",
    "Etc/GMT+9": "9",
    "Etc/GMT+10": "10",
    "Etc/GMT+11": "11",
    "Etc/GMT+12": "12",
    "Etc/GMT-0": "GMT0",
    "Etc/GMT-1": "-1",
    "Etc/GMT-2": "-2",
    "Etc/GMT-3": "-3",
    "Etc/GMT-4": "-4",
    "Etc/GMT-5": "-5",
    "Etc/GMT-6": "-6",
    "Etc/GMT-7": "-7",
    "Etc/GMT-8": "-8",
    "Etc/GMT-9": "-9",
    "Etc/GMT-10": "-10",
    "Etc/GMT-11": "-11",
    "Etc/GMT-12": "-12",
    "Etc/GMT-13": "-13",
    "Etc/GMT-14": "-14",
    "Etc/GMT0": "GMT0",
    "Etc/Greenwich": "GMT0",
    "Etc/UCT": "UTC0",
    "Etc/Universal": "UTC0",
    "Etc/UTC": "UTC0",
    "Etc/Zulu": "UTC0",
    "Europe/Amsterdam": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Andorra": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Astrakhan": "-4",
    "Europe/Athens": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Belfast": "GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Belgrade": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Berlin": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Bratislava": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Brussels": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Bucharest": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Budapest": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Busingen": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Chisinau": "EET-2EEST,M3.5.0,M10.5.0/3",
    "Europe/Copenhagen": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Dublin": "IST-1GMT0,M10.5.0,M3.5.0/1",
    "Europe/Gibraltar": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Guernsey": "GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Helsinki": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Isle_of_Man": "GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Istanbul": "-3",
    "Europe/Jersey": "GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Kaliningrad": "EET-2",
    "Europe/Kiev": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Kirov": "-3",
    "Europe/Lisbon": "WET0WEST,M3.5.0/1,M10.5.0",
    "Europe/Ljubljana": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/London": "GMT0BST,M3.5.0/1,M10.5.0",
    "Europe/Luxembourg": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Madrid": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Malta": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Mariehamn": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Minsk": "-3",
    "Europe/Monaco": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Moscow": "MSK-3",
    "Europe/Nicosia": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Oslo": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Paris": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Podgorica": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Prague": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Riga": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Rome": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Samara": "-4",
    "Europe/San_Marino": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Sarajevo": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Saratov": "-4",
    "Europe/Simferopol": "MSK-3",
    "Europe/Skopje": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Sofia": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Stockholm": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Tallinn": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Tirane": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Tiraspol": "EET-2EEST,M3.5.0,M10.5.0/3",
    "Europe/Ulyanovsk": "-4",
    "Europe/Uzhgorod": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Vaduz": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vatican": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vienna": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Vilnius": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Volgograd": "-3",
    "Europe/Warsaw": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Zagreb": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Europe/Zaporozhye": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Europe/Zurich": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Indian/Antananarivo": "EAT-3",
    "Indian/Chagos": "-6",
    "Indian/Christmas": "-7",
    "Indian/Cocos": "-6",
    "Indian/Comoro": "EAT-3",
    "Indian/Kerguelen": "-5",
    "Indian/Mahe": "-4",
    "Indian/Maldives": "-5",
    "Indian/Mauritius": "-4",
    "Indian/Mayotte": "EAT-3",
    "Indian/Reunion": "-4",
    "Mexico/BajaNorte": "PST8PDT,M3.2.0,M11.1.0",
    "Mexico/BajaSur": "MST7MDT,M4.1.0,M10.5.0",
    "Mexico/General": "CST6CDT,M4.1.0,M10.5.0",
    "Pacific/Apia": "-13",
    "Pacific/Auckland": "NZST-12NZDT,M9.5.0,M4.1.0/3",
    "Pacific/Bougainville": "-11",
    "Pacific/Chatham": "-12",
    "Pacific/Chuuk": "-10",
    "Pacific/Efate": "-11",
    "Pacific/Enderbury": "-13",
    "Pacific/Fakaofo": "-13",
    "Pacific/Funafuti": "-12",
    "Pacific/Galapagos": "6",
    "Pacific/Gambier": "9",
    "Pacific/Guadalcanal": "-11",
    "Pacific/Guam": "C",
    "Pacific/Honolulu": "HST10",
    "Pacific/Johnston": "HST10",
    "Pacific/Kiritimati": "-14",
    "Pacific/Kosrae": "-11",
    "Pacific/Kwajalein": "-12",
    "Pacific/Majuro": "-12",
    "Pacific/Marquesas": "9",
    "Pacific/Midway": "SST11",
    "Pacific/Nauru": "-12",
    "Pacific/Niue": "11",
    "Pacific/Norfolk": "-11",
    "Pacific/Noumea": "-11",
    "Pacific/Pago_Pago": "SST11",
    "Pacific/Palau": "-9",
    "Pacific/Pitcairn": "8",
    "Pacific/Pohnpei": "-11",
    "Pacific/Ponape": "-11",
    "Pacific/Port_Moresby": "-10",
    "Pacific/Rarotonga": "10",
    "Pacific/Saipan": "C",
    "Pacific/Samoa": "SST11",
    "Pacific/Tahiti": "10",
    "Pacific/Tarawa": "-12",
    "Pacific/Tongatapu": "-13",
    "Pacific/Truk": "-10",
    "Pacific/Wake": "-12",
    "Pacific/Wallis": "-12",
    "Pacific/Yap": "-10",
    "US/Alaska": "AKST9AKDT,M3.2.0,M11.1.0",
    "US/Aleutian": "HST10HDT,M3.2.0,M11.1.0",
    "US/Arizona": "MST7",
    "US/Central": "CST6CDT,M3.2.0,M11.1.0",
    "US/East-Indiana": "EST5EDT,M3.2.0,M11.1.0",
    "US/Eastern": "EST5EDT,M3.2.0,M11.1.0",
    "US/Hawaii": "HST10",
    "US/Indiana-Starke": "CST6CDT,M3.2.0,M11.1.0",
    "US/Michigan": "EST5EDT,M3.2.0,M11.1.0",
    "US/Mountain": "MST7MDT,M3.2.0,M11.1.0",
    "US/Pacific": "PST8PDT,M3.2.0,M11.1.0",
    "US/Samoa": "SST11",
    "CET": "CET-1CEST,M3.5.0,M10.5.0/3",
    "CST6CDT": "CST6CDT,M3.2.0,M11.1.0",
    "Cuba": "CST5CDT,M3.2.0/0,M11.1.0/1",
    "EET": "EET-2EEST,M3.5.0/3,M10.5.0/4",
    "Egypt": "EET-2",
    "EST": "EST5",
    "EST5EDT": "EST5EDT,M3.2.0,M11.1.0",
    "GMT": "GMT0",
    "GMT0": "GMT0",
    "Greenwich": "GMT0",
    "Hongkong": "HKT-8",
    "HST": "HST10",
    "Iceland": "GMT0",
    "Iran": "-3",
    "Jamaica": "EST5",
    "Japan": "JST-9",
    "Kwajalein": "-12",
    "Libya": "EET-2",
    "MET": "MET-1MEST,M3.5.0,M10.5.0/3",
    "MST": "MST7",
    "MST7MDT": "MST7MDT,M3.2.0,M11.1.0",
    "Navajo": "MST7MDT,M3.2.0,M11.1.0",
    "Poland": "CET-1CEST,M3.5.0,M10.5.0/3",
    "Portugal": "WET0WEST,M3.5.0/1,M10.5.0",
    "PST8PDT": "PST8PDT,M3.2.0,M11.1.0",
    "ROC": "CST-8",
    "ROK": "KST-9",
    "Singapore": "-8",
    "Turkey": "-3",
    "UCT": "UTC0",
    "UTC": "UTC0",
    "WET": "WET0WEST,M3.5.0/1,M10.5.0",
};

var timeUpdateTimer;
function updateTime() {
  clearTimeout(timeUpdateTimer);
  $.ajax({
    url: '/getTimeString',
    dataType: 'json',
  })                  
    .done(function(returnedTimeJson) {
      if (returnedTimeJson.message == 'ok')
      {
        $('span.currentTime').text(returnedTimeJson.time);
        timeUpdateTimer = setTimeout(updateTime, 30000);
      }                  
    });
}
        
function setupInputButtons()
{
  $('.btn-plus, .btn-minus').off('click');
  $('.btn-plus, .btn-minus').on('click', function(e) {
    const isNegative = $(e.target).closest('.btn-minus').is('.btn-minus');
    const input = $(e.target).closest('.input-group').find('input');
    if (input.is('input')) {
      input[0][isNegative ? 'stepDown' : 'stepUp'](10);
      input.trigger('change');
    }
  })
}

function getFastPresetLoadingSetting()
{
  return $('#fastPresetLoadingSwitch').is(':checked');
}

function getMoveSpeedSetting()
{
  let input = $('#tabSettings input.speedSetting');
  if (!input.is(":invalid") && input.val() <= 100 && input.val() > 0)
    return input.val();
  return 100;
}

function formatDaysShort(days)
{
  let result = "";  
  if (days == (1 | 1<<6))
    result = "Weekends";
  else if (days == (1<<1 | 1<<2 | 1<<3 | 1<<4 | 1<<5))
    result = "Workdays";
  else if (days == (1 | 1<<1 | 1<<2 | 1<<3 | 1<<4 | 1<<5 | 1<<6))
    result = "All";
  else
  {
    let daysString = "MTWTFSS";
    for (let i = 2; i <= 7; i++)
    {
      if (days & (1<<(i-1)))
        result = result + daysString.charAt(i-2)
      else
        result = result + '-';
    }
    if (days & 1)
      result = result + daysString.charAt(6);
    else
      result = result + '-';
  }
  return result;
}

function formatWindowsShort(room, windows)
{
  let result = "";
  
  if (windows == 0)
    result = "None";
  else
  {
    let allWindows = true;
    let selectedCount = 0;
    for (const blind of room.blinds)
    {
      if (windows & (1<<(blind.blindId-1)))
      {
        if (result != "")
          result = result + " ";
        result = result + blind.blindId;
        selectedCount++;
      }
      else
        allWindows = false;
    }
    if (allWindows)
      result = "All";
    if (selectedCount == 0)
      result = "None";
    if (result.length > 14)
      result = selectedCount + " selected";
  }
  return result;
}

function setupRowStatusIndicators(request, thisRow)
{
  thisRow.find('td:last-child div.statusLoading').attr("hidden", false);
  if (thisRow.data("timer"))
    clearTimeout(thisRow.data("timer"));
  thisRow.find('td:last-child .statusFail, td:last-child .statusOk').finish();
  thisRow.find('td:last-child .statusFail, td:last-child .statusOk').attr("hidden", true);
  request.done(function(data) {
    thisRow.find('td:last-child div.statusLoading').attr("hidden", true)
    if (data.message == 'ok')
      thisRow.find('td:last-child .statusOk').attr("hidden", false)
    else
      thisRow.find('td:last-child .statusFail').attr("hidden", false)
  })
  .fail(function() {
    thisRow.find('td:last-child div.statusLoading').attr("hidden", true)
    thisRow.find('td:last-child .statusFail').attr("hidden", false)
  })
  .always(function() {
    thisRow.data("timer", setTimeout(function(){
      thisRow.find('td:last-child .statusFail, td:last-child .statusOk').fadeOut({
        complete: function() {
          $(this).attr("hidden", true)
          $(this).css({"display": ""});
          }
      })
    }, 2000))
  });
}

function setupScheduleSubmit(url, buttonText, roomId, index)
{
  $('#editScheduleModal .submitSchedule').text(buttonText);
  $('#editScheduleModal .submitSchedule').off('click');
  $('#editScheduleModal .submitSchedule').click(function(){
    let foundError = false;
    let result = {};
    if (index != null)
      result.index = index;
    result.roomId = roomId;
    if ($('#datetimepickerSchedule').data('DateTimePicker').date() != null)
    {
      result.timeH = $('#datetimepickerSchedule').data('DateTimePicker').date().hour();
      result.timeM = $('#datetimepickerSchedule').data('DateTimePicker').date().minute();
    }
    else 
      foundError = true;
    result.days = 0;
    $('#multiselectDaysSchedule option:selected').each(function(index, day){
      result.days = result.days | (1 << ($(this).val() - 1));
    });
    result.preset = $('#editScheduleModal .presetSelect').val();
    result.windows = 0;
    $('#multiselectBlindsSchedule option:selected').each(function(index, blind){
      result.windows = result.windows | (1 << ($(this).val() - 1));
    });
    result.speed = $('#editScheduleModal input.quantity').val();
    
    foundError = foundError ||
                 $('#editScheduleModal .presetSelect').is(":invalid") || 
                 $('#editScheduleModal input.quantity').is(":invalid") || 
                 !(result.speed <= 100 && result.speed > 0) ||
                 result.windows == 0 ||
                 result.days == 0
    if (foundError)
    {
      $('#editScheduleModal .modal-body .alert-dismissible').remove();
      $('#editScheduleModal .modal-body').prepend('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i><strong> Error:</strong> Some fields are not filled in correctly.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
    }
    else
    {
      let errorAlert = $('<div class="alert alert-danger alert-dismissible fade show" role="alert"><i class="fa fa-exclamation-triangle" aria-hidden="true"></i> An error occured.<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button></div>');
      $('#editScheduleModal .submitSchedule').attr("disabled", true);
      $.ajax({
        url: url,
        data: result,
        dataType: 'json',
      })
        .done(function(data) {
          if (data.message == 'ok')
          {
            $('#editScheduleModal').modal('hide');
            reloadStatus(false);
          }
          else
            $('#editScheduleModal .modal-body').prepend(errorAlert);
        })
        .fail(function() {
          $('#editScheduleModal .modal-body').prepend(errorAlert);
        })
        .always(function() {
          $('#editScheduleModal .submitSchedule').attr("disabled", false);
        });
    }
  });
}

function reloadStatus(refreshPositions)
{
  $('#devicesNoBlindsMessage').attr("hidden", true);
  $('#homeNoBlindsMessage').attr("hidden", true);
  $('#homeErrorMessage').attr("hidden", true);
  $('#devicesErrorMessage').attr("hidden", true);
  $('#homeLoadingMessage').attr("hidden", false);
  $('#devicesLoadingMessage').attr("hidden", false);
  $('#tabHome div.row:eq(0) .roomDiv').remove();
  $('#tabDevices table.devices-table tbody').empty();
  
  $('#scheduleNoSchedulesMessage').attr("hidden", true);
  $('#scheduleErrorMessage').attr("hidden", true);
  $('#scheduleLoadingMessage').attr("hidden", false);
  $('#tabSchedule div.row:eq(0) .scheduleDiv').remove();
  $.ajax({
    url: '/getStatus',
    data: {
      refreshPositions: refreshPositions
    },
    dataType: 'json',
  })
    .done(function(retunedJson) {
      //retunedJson = {"timezoneOlson":"CET", "rooms":[{"roomId":1,"blinds":[{"blindId":1,"currentTargetPercent":100},{"blindId":2,"currentTargetPercent":0}],"presets":[[0,0],[0,0],[0,0],[0,0]],"schedules":[{"timeH":17,"timeM":53,"days":48,"preset":4,"windows":3,"speed":100,"nextTrigger":1616691180}]}, {"roomId":2,"blinds":[{"blindId":1,"currentTargetPercent":100},{"blindId":2,"currentTargetPercent":0}],"presets":[[0,0],[0,0],[0,0],[0,0]],"schedules":[{"timeH":17,"timeM":53,"days":48,"preset":4,"windows":3,"speed":100,"nextTrigger":1616691180}]}]}
      lastBlindsData = retunedJson;
      if (!retunedJson.hasOwnProperty('rooms') || retunedJson.rooms.length == 0)
      {
        $('#devicesNoBlindsMessage').attr("hidden", false);
        $('#homeNoBlindsMessage').attr("hidden", false);
        $('#scheduleNoBlindsMessage').attr("hidden", false);
      }
      else
      {
        //home screen
        for (const room of retunedJson.rooms) 
        {
          let roomDiv = $('<div class="col-lg-6 roomDiv"></div>');
          $('#tabHome div.row:eq(0)').append(roomDiv);
          roomDiv.append('<div class="row"><div class="col-lg-12"><h2>Room '+room.roomId+'</h2></div></div>');
          roomDiv.append('<table class="table blinds-table"><thead><tr><th>Window</th><th>%</th><th>Send</th><th style="width: 2rem"></th></tr></thead><tbody></tbody></table>');
          let tableBody = roomDiv.find('table.blinds-table tbody');
          for (const blind of room.blinds) 
          {
            let newRow = $('<tr data-blindId='+blind.blindId+'"><td>'+blind.blindId+'</td><td><div class="input-group inline-group"><div class="input-group-prepend"><button class="btn btn-primary btn-minus"><i class="fa fa-chevron-left"></i></button></div><input class="form-control quantity" min="0" max="100" step="1" name="quantity" value="'+blind.currentTargetPercent+'" type="number"><div class="input-group-append"><button class="btn btn-primary btn-plus"><i class="fa fa-chevron-right"></i></button></div></div></td><td><button class="btn btn-primary sendTargetButton"><i class="fa fa-check"></i></button></td><td><div class="spinner-border spinner-border-sm statusLoading" role="status" hidden></div><i class="fa fa-check statusOk" style="color: green;" hidden aria-hidden="true"></i><i class="fa fa-times statusFail" style="color: red;" hidden aria-hidden="true"></i></td></tr>');
            tableBody.append(newRow);
            newRow.find('.sendTargetButton').click(function(){
              let thisButton = $(this);
              let thisRow = $(this).parent().parent();
              let input = thisRow.find('input[type=number]');
              if (!input.is(":invalid") && input.val() <= 100 && input.val() >= 0)
              {
                let targetPercent = input.val();
                thisButton.attr("disabled", true);
                let request = $.ajax({
                  url: '/setBlinds',
                  data: { 
                    roomId: room.roomId, 
                    blindNumber: blind.blindId, 
                    targetPercent: targetPercent,
                    speed: getMoveSpeedSetting()
                  },
                  dataType: 'json',
                })
                setupRowStatusIndicators(request, thisRow);
                request.always(function() {
                    thisButton.attr("disabled", false)
                });
              }
            });
          }
          let presetsSection = $('<div class="row pb-5"> <div class="col-auto"> <table class="table table-borderless presets-table"> <thead> <tr> <th> Load Preset </th> </tr></thead> <tbody> <tr> <td> <button class="btn btn-primary loadPresetButton" value="1">1</button> <button class="btn btn-primary loadPresetButton" value="2">2</button> <button class="btn btn-primary loadPresetButton" value="3">3</button> <button class="btn btn-primary loadPresetButton" value="4">4</button> </td></tr></tbody> </table> </div><div class="col"></div><div class="col-auto"> <table class="table table-borderless presets-table"> <thead> <tr> <th> Save Preset </th> <th style="width: 2rem"></th> </tr></thead> <tbody> <tr> <td> <select class="form-control pt-2 preset-save-select"> <option value="1">Preset 1</option> <option value="2">Preset 2</option> <option value="3">Preset 3</option> <option value="4">Preset 4</option> </select> <button class="btn btn-primary savePresetButton">Save</button></td><td><div class="spinner-border spinner-border-sm statusLoading" role="status" hidden></div><i class="fa fa-check statusOk" style="color: green;" hidden aria-hidden="true"></i><i class="fa fa-times statusFail" style="color: red;" hidden aria-hidden="true"></i></td></tr></tbody> </table> </div></div>');
          roomDiv.append(presetsSection);
          presetsSection.find('.loadPresetButton').click(function(){
            let presetIndex = $(this).attr('value')-1;
            for (let i = 0; i < room.presets[presetIndex].length; i++)
              tableBody.find('input.quantity').eq(i).val(room.presets[presetIndex][i]);
              if (getFastPresetLoadingSetting())
                tableBody.find('.sendTargetButton').click();                
          });
          presetsSection.find('.savePresetButton').click(function(){
            let thisRow = $(this).parent().parent();
            let presetIndex = $(this).parent().find('select.preset-save-select').val()-1;
            let newPreset = room.presets[presetIndex].slice();
            let error = false;
            for (let i = 0; i < room.presets[presetIndex].length; i++)
            {
              let input = tableBody.find('input.quantity').eq(i);
              if (!input.is(":invalid") && input.val() <= 100 && input.val() >= 0)
                newPreset[i] = parseInt(input.val());
              else
              {
                error = true;
                break;
              }
            }
            
            if (!error)
            {
              let request = $.ajax({
                url: '/updatePreset',
                method: 'POST',
                data: JSON.stringify({
                  roomId: room.roomId,
                  presetIndex: presetIndex,
                  newPreset: newPreset
                }),
                dataType: 'json',
                contentType: 'application/json',
              });
              
              setupRowStatusIndicators(request, thisRow);              
              request.done(function(data) {
                if (data.message == 'ok')
                  room.presets[presetIndex] = newPreset;
              });
            }
          });
        }
        setupInputButtons();

        //devices screen
        let hasDevices = false
        for (const room of retunedJson.rooms) 
        {
          let tableBody = $('#tabDevices table.devices-table tbody');
          for (const blind of room.blinds) 
          {
            hasDevices = true
            let newRow = $('<tr><td>'+room.roomId+'</td><td>'+blind.blindId+'</td><td><button class="btn btn-primary pingButton">Ping</button>    <button class="btn btn-primary calibrateButton" data-toggle="modal" data-target="#calibrateModal">Calibrate</button> <button class="btn btn-danger deleteButton"><i class="fa fa-trash fa-lg"></i></button></td><td><div class="spinner-border spinner-border-sm statusLoading" role="status" hidden></div><i class="fa fa-check statusOk" style="color: green;" hidden aria-hidden="true"></i><i class="fa fa-times statusFail" style="color: red;" hidden aria-hidden="true"></i></td></tr>')
            tableBody.append(newRow);
            newRow.find('.pingButton').click(function(){
              let thisButton = $(this)
              let thisRow = $(this).parent().parent()
              let deleteButton = thisRow.find('.deleteButton')
              thisButton.attr("disabled", true)
              deleteButton.attr("disabled", true)
              let request = $.ajax({
                url: '/setBlinds',
                data: { 
                  roomId: room.roomId, 
                  blindNumber: blind.blindId, 
                  targetPercent: -1,
                },
                dataType: 'json',
              });
              setupRowStatusIndicators(request, thisRow);
              request.always(function() {
                thisButton.attr("disabled", false)
                deleteButton.attr("disabled", false)
              });
            });
            newRow.find('.deleteButton').click(function(){
              let thisButton = $(this)
              let thisRow = $(this).parent().parent()
              let pingButton = thisRow.find('.pingButton')
              thisButton.attr("disabled", true)
              pingButton.attr("disabled", true)
              let request = $.ajax({
                url: '/forgetBlind',
                data: { 
                  roomId: room.roomId, 
                  blindNumber: blind.blindId, 
                },
                dataType: 'json',
              });
              setupRowStatusIndicators(request, thisRow);
              request.done(function(data) {
                if (data.message == 'ok')
                  reloadStatus(false);
              })
              .always(function() {
                thisButton.attr("disabled", false)
                pingButton.attr("disabled", false)
              });
            });
            newRow.find('.calibrateButton').click(function(){
              //TARGET_DISCOVER = -1; //does nothing, just send the latest ack packet
              //TARGET_SET_START = -2;
              //TARGET_SET_END = -3;
              //TARGET_MOVE_BACK = -4;
              //TARGET_MOVE_FWD = -5;
              
              $('#calibrateModal .modal-body .setTopButton').off('click');
              $('#calibrateModal .modal-body .setTopButton').click(function(){
                let thisButton = $(this);
                thisButton.attr("disabled", false)
                let request = $.ajax({
                  url: '/setBlinds',
                  data: { 
                    roomId: room.roomId, 
                    blindNumber: blind.blindId, 
                    targetPercent: -2,
                    speed: 100
                  },
                  dataType: 'json',
                });
                request.always(function() {
                  thisButton.attr("disabled", false)
                });
              });
              $('#calibrateModal .modal-body .setBottomButton').off('click');
              $('#calibrateModal .modal-body .setBottomButton').click(function(){
                let thisButton = $(this);
                thisButton.attr("disabled", false)
                let request = $.ajax({
                  url: '/setBlinds',
                  data: { 
                    roomId: room.roomId, 
                    blindNumber: blind.blindId, 
                    targetPercent: -3,
                    speed: 100
                  },
                  dataType: 'json',
                });
                request.always(function() {
                  thisButton.attr("disabled", false)
                });
              });
              $('#calibrateModal .modal-body .moveUpButton').off('touchstart mousedown');
              $('#calibrateModal .modal-body .moveUpButton').off('touchend mouseup mouseleave');
              var sendingUp = false;
              $('#calibrateModal .modal-body .moveUpButton').on('touchstart mousedown', function(e){
                e.preventDefault(); //prevents further events from being dispatched
                let thisButton = $(this);
                sendingUp = true;
                function sendRequest() 
                {
                  let startTime = new Date();
                  let request = $.ajax({
                    url: '/setBlinds',
                    data: { 
                      roomId: room.roomId, 
                      blindNumber: blind.blindId, 
                      targetPercent: -4,
                      speed: 100
                    },
                    dataType: 'json',
                  });
                  request.done(function(returnedTimeJson) {
                    if (returnedTimeJson.message == 'ok' && sendingUp)
                    {
                      let endTime = new Date();
                      let timeDiff = endTime - startTime;
                      if (timeDiff > 90)
                        sendRequest();
                      else
                        setTimeout(sendRequest, 90 - timeDiff);
                    }
                  });
                }
                sendRequest();
              });
              $('#calibrateModal .modal-body .moveUpButton').on('touchend mouseup mouseleave', function(){
                sendingUp = false;
              });
              
              $('#calibrateModal .modal-body .moveDownButton').off('touchstart mousedown');
              $('#calibrateModal .modal-body .moveDownButton').off('touchend mouseup mouseleave');
              var sendingDown = false;
              $('#calibrateModal .modal-body .moveDownButton').on('touchstart mousedown', function(e){
                e.preventDefault(); //prevents further events from being dispatched
                let thisButton = $(this);
                sendingDown = true;
                function sendRequest() 
                {
                  let startTime = new Date();
                  let request = $.ajax({
                    url: '/setBlinds',
                    data: { 
                      roomId: room.roomId, 
                      blindNumber: blind.blindId, 
                      targetPercent: -5,
                      speed: 100
                    },
                    dataType: 'json',
                  });
                  request.done(function(returnedTimeJson) {
                    if (returnedTimeJson.message == 'ok' && sendingDown)
                    {
                      let endTime = new Date();
                      let timeDiff = endTime - startTime;
                      if (timeDiff > 90)
                        sendRequest();
                      else
                        setTimeout(sendRequest, 90 - timeDiff);
                    }
                  });
                }
                sendRequest();
              });
              $('#calibrateModal .modal-body .moveDownButton').on('touchend mouseup mouseleave', function(){
                sendingDown = false;
              });
            });
          }
        }
        $('#pingAll').attr("disabled", !hasDevices);
        
        //schedules screen
        let schedulesDiv = $('#tabSchedule div.row:eq(0)');
        for (const room of retunedJson.rooms) 
        {
          let newRoom = $('<div class="col-lg-8 scheduleDiv"><div class="row"><div class="col-lg-12"><h2>Room '+room.roomId+'</h2></div></div><table class="table schedule-table"><thead><tr><th>Time</th><th>Days</th><th>Preset</th><th>Windows</th><th>Speed</th><th></th><th style="width: 2rem"></th></tr></thead><tbody></tbody></table><button class="btn btn-primary float-right addScheduleButton" data-toggle="modal" data-target="#editScheduleModal">Add schedule</button> </div><div class="col-lg-4 scheduleDiv"></div>');
          schedulesDiv.append(newRoom);
          let roomTableBody = newRoom.find('table.schedule-table tbody');
          newRoom.find('.addScheduleButton').click(function(){
            $('#editScheduleModalLabel').text('Add schedule');
            $('#editScheduleModal .modal-body .alert-dismissible').remove();              
            $('#multiselectBlindsSchedule').empty();
            for (const blind of room.blinds)
              $('#multiselectBlindsSchedule').append($("<option></option>").attr("value", blind.blindId).text(blind.blindId));             
            $('#multiselectBlindsSchedule').multiselect('rebuild');
            $('#multiselectBlindsSchedule').multiselect('selectAll', false);
            setupScheduleSubmit('/addSchedule', 'Add', room.roomId);
          });
          let index = 0;
          for (const schedule of room.schedules) 
          {
            const currentIndex = index++;
            let newRow = $('<tr><td>'+moment({ hour:schedule.timeH, minute:schedule.timeM }).format('LT')+'</td><td>'+formatDaysShort(schedule.days)+'</td><td>'+schedule.preset+'</td><td>'+formatWindowsShort(room, schedule.windows)+'</td><td>'+schedule.speed+'</td><td><button class="btn btn-primary editScheduleButton" data-toggle="modal" data-target="#editScheduleModal"><i class="fa fa-pencil fa-lg"></i></button> <button class="btn btn-danger deleteScheduleButton"><i class="fa fa-trash fa-lg"></i></button></td><td><div class="spinner-border spinner-border-sm statusLoading" role="status" hidden></div><i class="fa fa-check statusOk" style="color: green;" hidden aria-hidden="true"></i><i class="fa fa-times statusFail" style="color: red;" hidden aria-hidden="true"></i></td></tr>');
            roomTableBody.append(newRow);
            newRow.find('.editScheduleButton').click(function(){
              $('#editScheduleModalLabel').text('Edit schedule');
              $('#editScheduleModal .modal-body .alert-dismissible').remove();
              $('#datetimepickerSchedule').datetimepicker('date', moment({ hour:schedule.timeH, minute:schedule.timeM }));
              for (let i = 1; i <= 7; i++)
              {
                if (schedule.days & (1<<(i-1)))
                  $('#multiselectDaysSchedule').multiselect('select', i);
                else
                  $('#multiselectDaysSchedule').multiselect('deselect', i);
              }
              $('#editScheduleModal .presetSelect').val(schedule.preset);
              
              $('#multiselectBlindsSchedule').empty();
              let maxBlindId = 0;
              for (const blind of room.blinds)
              {
                $('#multiselectBlindsSchedule').append($("<option></option>").attr("value", blind.blindId).text(blind.blindId)); 
                if (blind.blindId > maxBlindId)
                  maxBlindId = blind.blindId
              }                    
              $('#multiselectBlindsSchedule').multiselect('rebuild');
              for (let i = 1; i <= maxBlindId; i++)
              {
                if (schedule.windows & (1<<(i-1)))
                  $('#multiselectBlindsSchedule').multiselect('select', i);
                else
                  $('#multiselectBlindsSchedule').multiselect('deselect', i);
              }              
              $('#editScheduleModal input.quantity').val(schedule.speed);
              setupScheduleSubmit('/editSchedule', 'Save', room.roomId, currentIndex);
            });
            
            newRow.find('.deleteScheduleButton').click(function(){
              let thisButton = $(this);
              let thisRow = $(this).parent().parent();
              let otherButton = thisRow.find('.editScheduleButton')
              thisButton.attr("disabled", true)
              otherButton.attr("disabled", true)
              let request = $.ajax({
                url: '/deleteSchedule',
                data: { 
                  roomId: room.roomId,
                  index: currentIndex
                },
                dataType: 'json',
              });
              setupRowStatusIndicators(request, thisRow);
              request.done(function(data) {
                if (data.message == 'ok')
                  reloadStatus(false);
              })
              .always(function() {
                thisButton.attr("disabled", false)
                otherButton.attr("disabled", false)
              });
            });
          }
        }
        if (retunedJson.hasOwnProperty('timezoneOlson'))
        {
          schedulesDiv.find('.col-lg-4.scheduleDiv:eq(0)').append('<h4 class="pt-4 d-none d-lg-block">Current time</h4><span class="currentTime d-none d-lg-block">...</span>');
          schedulesDiv.append('<div class="col-lg-8 scheduleDiv"><h4 class="pt-4 d-lg-none">Current time</h4><span class="currentTime d-lg-none">...</span> </div>');
        }
      }
      
      if (retunedJson.hasOwnProperty('timezoneOlson'))
      {
        //settings screen
        $('#timeZoneSelect').multiselect('deselectAll', false);
        $('#timeZoneSelect').multiselect('select', retunedJson.timezoneOlson);
        $('#timeZoneSelect').multiselect('updateButtonText');
        $('#timeZoneSelect').multiselect('refresh');
        $('#tabSettings div.col-md-6:eq(1)').empty();
        $('#tabSettings div.col-md-6:eq(1)').append('<h4 class="pt-4">Current time</h4><span class="currentTime">...</span>');
        
        updateTime();
      }          
    })
    .fail(function() {
      $('#homeErrorMessage').attr("hidden", false);
      $('#devicesErrorMessage').attr("hidden", false);
      $('#scheduleErrorMessage').attr("hidden", false);
    })
    .always(function() {
      $('#homeLoadingMessage').attr("hidden", true);
      $('#devicesLoadingMessage').attr("hidden", true);
      $('#scheduleLoadingMessage').attr("hidden", true);
    });
}

$(document).ready(function() {
  $(function () {
    $('[data-toggle="tooltip"]').tooltip()
  })
  setupInputButtons();
  
  let timeZoneSelect = $('#timeZoneSelect');
  Object.keys(tzinfo).forEach(function(k){
    timeZoneSelect.append($("<option></option>").attr("data-timezone", tzinfo[k]).attr("value", k).text(k));             
  });
  
  timeZoneSelect.multiselect({
    buttonWidth: '20rem',
    maxHeight: '400',
    enableFiltering: true,
    enableCaseInsensitiveFiltering: true,
    onChange: function(option, checked, select) {
      if (checked)
      {
        let request = $.ajax({
          url: '/setTimezone',
          data: { 
            timezonePosix: option.attr('data-timezone'),
            timezoneOlson: option.attr('value')
          },
          dataType: 'json',
        })            
          .done(function(returnedJson) {
            if (returnedJson.message == 'ok')
              updateTime();
          });
      }
    }
  });
  
  reloadStatus(true);

  // settings
  if (typeof(Storage) !== "undefined") {
    let fastPresetLoading = localStorage.getItem('fastPresetLoading');
    if(null === fastPresetLoading)
      fastPresetLoading = true;
    $('#fastPresetLoadingSwitch').val(fastPresetLoading);
    let moveSpeed = localStorage.getItem('moveSpeed');
    if(null === moveSpeed)
      moveSpeed = 100;
    $('#tabSettings input.speedSetting').val(moveSpeed);
  } else {
    console.log("Local storage not supported, some settings will not be saved");
  }
  
  $('#fastPresetLoadingSwitch').change(function() {
    if (typeof(Storage) !== "undefined") {
      localStorage.setItem("fastPresetLoading", this.checked);
    }
  });
  $('#tabSettings input.speedSetting').change(function() {
    if (typeof(Storage) !== "undefined" && !$(this).is(":invalid") && $(this).val() <= 100 && $(this).val() > 0) {
      localStorage.setItem("moveSpeed", $(this).val());
    }
  }); 

  $('#pingAll').click(function(){
    $('#tabDevices table.devices-table tbody .pingButton').click();
  });
  
  $('#scanForDevices').click(function(){
    $('#discoverModal [data-dismiss="modal"]').attr("disabled", true);
    $('#discoverModal .progress-bar').css('width', 0+'%').attr('aria-valuenow', 0);    
    $('#discoverModal .devicesCountNew').text(0)
    $('#discoverModal .devicesCountTotal').text(0)
    $('#discoverModal .searchingStatus').attr("hidden", false);
    $('#discoverModal .searchingStatus .statusSearching').attr("hidden", false);
    $('#discoverModal .searchingStatus .statusFinished').attr("hidden", true);
    $('#discoverModal .alert').attr("hidden", true);
    $.ajax({
      url: '/startDiscover',
      dataType: 'json',
    })
      .done(function(data) {
        if (data.message == 'ok')
        {
          let timer = setTimeout(checkStatus, 500);
          function checkStatus() {
            $.ajax({
              url: '/getDiscoveryStatus',
              dataType: 'json',
            })                  
              .done(function(discoveryData) {
                $('#discoverModal .progress-bar').css('width', discoveryData.percent+'%').attr('aria-valuenow', discoveryData.percent);    
                $('#discoverModal .devicesCountNew').text(discoveryData.devicesCountNew)
                $('#discoverModal .devicesCountTotal').text(discoveryData.devicesCountTotal)
                if (discoveryData.percent >= 100)
                {
                  $('#discoverModal [data-dismiss="modal"]').attr("disabled", false);
                  $('#discoverModal .searchingStatus .statusSearching').attr("hidden", true);
                  $('#discoverModal .searchingStatus .statusFinished').attr("hidden", false);
                  reloadStatus(false);
                }
                else
                  timer = setTimeout(checkStatus, 500);
              })
              .fail(function() {
                $('#discoverModal [data-dismiss="modal"]').attr("disabled", false);
                $('#discoverModal .alert').attr("hidden", false);
              });
          }
        }
        else
        {
          $('#discoverModal [data-dismiss="modal"]').attr("disabled", false);
          $('#discoverModal .searchingStatus').attr("hidden", true);
          $('#discoverModal .alert').attr("hidden", false);
        }
      })
      .fail(function() {
        $('#discoverModal [data-dismiss="modal"]').attr("disabled", false);
        $('#discoverModal .searchingStatus').attr("hidden", true);
        $('#discoverModal .alert').attr("hidden", false);
      })
  });
 
  // other
  $('#discoverModal').modal({
    backdrop: 'static',
    keyboard: false,
    show: false
  })

  $('#multiselectDaysSchedule').multiselect({
    buttonWidth: '18rem',
    buttonText: function(options, select) {
        if (options.length === 0) {
            return 'None';
        }
        else if (options.length == 7) {
            return 'All';
        }
        else if (options.length == 2 && options[0].index == 5 && options[1].index == 6)
        {
            return 'Weekends'
        }
        else if (options.length == 5 && options[0].index == 0 && options[1].index == 1 && options[2].index == 2 && options[3].index == 3 && options[4].index == 4)
        {
            return 'Workdays'
        }
        else {
             let labels = [];
             options.each(function() {
                 if ($(this).attr('label') !== undefined) {
                     labels.push($(this).attr('label'));
                 }
                 else {
                     labels.push($(this).html());
                 }
             });
             return labels.join(', ') + '';
         }
    }
  });
  $('#multiselectBlindsSchedule').multiselect({
    buttonWidth: '10rem',
    buttonText: function(options, select) {
        if (options.length === 0) {
            return 'None';
        }
        else if (options.length == select[0].length) {
            return 'All';
        }
        else if (options.length > 5) {
            return options.length + ' selected';
        }
         else {
             let labels = [];
             options.each(function() {
                 if ($(this).attr('label') !== undefined) {
                     labels.push($(this).attr('label'));
                 }
                 else {
                     labels.push($(this).html());
                 }
             });
             return labels.join(', ') + '';
         }
    }
  });
        
  $('#datetimepickerSchedule').datetimepicker({
    format: 'LT',
    allowInputToggle: true,
    focusOnShow: false,
    ignoreReadonly: true
  });
  
  

});